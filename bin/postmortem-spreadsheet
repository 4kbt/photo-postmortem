#!/usr/bin/env ruby

require "active_support/core_ext/time"
require "byebug"
require "mini_exiftool_vendored"
require "optparse"
require "spreadsheet"

def main
  options = parse_commandline_options

  start_times = get_photo_creation_times(options[:start_photo_directory],
                                         options[:timezone])
  end_times = get_photo_creation_times(options[:end_photo_directory],
                                       options[:timezone])

  workbook = create_workbook(options[:spreadsheet])
  add_to_worksheet(worksheet: workbook.worksheet(0),
                   start_times: start_times,
                   end_times: end_times)
  workbook.write(options[:spreadsheet])
end

def add_time(rows, name, times)
  times.each do |time|
    date_str = to_local_date_string(time)
    rows[date_str] ||= {}
    rows[date_str][name] = to_local_time_string(time)
  end
end

def add_to_worksheet(worksheet:,
                     start_times:,
                     end_times:)
  rows = {}
  add_time(rows, :start, start_times)
  add_time(rows, :end, end_times)

  worksheet.insert_row(0, ['Day', 'Start', 'End'])
  rows.sort.each do |day, values|
    worksheet.insert_row(1, [day, values[:start], values[:end]])
  end
end

# Without this the Excel spreadsheet shows the time in UTC
def to_local_time_string(time)
  time.strftime('%Y/%m/%d %H:%M')
end
def to_local_date_string(time)
  time.strftime('%Y/%m/%d')
end

def create_workbook(spreadsheet_filename)
  fail "Spreadsheet already exists" if File.exist?(spreadsheet_filename)

  workbook = Spreadsheet::Workbook.new
  workbook.create_worksheet

  return workbook
end

def get_photo_creation_times(photo_directory, timezone)
  creation_times = []
  print "Reading #{photo_directory}"
  Dir.entries(photo_directory).each do |photo_filename|
    photo_path = File.join(photo_directory, photo_filename)
    next if File.directory?(photo_path)
    print "."
    $stdout.flush
    exif = MiniExiftool.new(photo_path)

    creation_time = exif.create_date
    creation_time = creation_time.in_time_zone(timezone) if timezone
    creation_times << creation_time
  end
  print "\n"

  creation_times
end

def parse_commandline_options
  options = {}
  required_options = []
  option_parser = OptionParser.new do |opts|
    opts.banner = "Usage: photo-postmortem OPTIONS"

    required_options << 'spreadsheet'
    opts.on("--spreadsheet=FILENAME", "The spreadsheet file to create") do |v|
      options[:spreadsheet] = v
    end

    required_options << 'start-photo-directory'
    opts.on("--start-photo-directory=DIRECTORY", "Directory containing start-of-day photos.") do |v|
      options[:start_photo_directory] = v
    end

    required_options << 'end-photo-directory'
    opts.on("--end-photo-directory=DIRECTORY", "Directory containing end-of-day photos.") do |v|
      options[:end_photo_directory] = v
    end

    timezones = ActiveSupport::TimeZone.all.map { |tz| tz.name }.sort.join(", ")
    opts.on("--timezone=NAME", "Name of the timezone for the dates in the spreadsheet. #{timezones}") do |v|
      options[:timezone] = v
    end

    opts.on_tail("--help", "This help message.") do |v|
      puts opts
      exit
    end
  end

  option_parser.parse!

  required_options.each do |required_option|
    next unless options[required_option.gsub('-', '_').to_sym].nil?
    raise OptionParser::MissingArgument.new("--#{required_option}")
  end

  return options
end

main

